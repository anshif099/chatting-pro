<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LuxChat - WhatsApp Style Secure Chat</title>
  <style>
    :root {
      --bg: #0a1014;
      --wa-green: #075E54;
      --wa-accent: #128C7E;
      --wa-chat: #DCF8C6;
      --panel: #0e151aee;
      --text: #e8edf1;
      --muted: #9fb0c9;
      --radius: 18px;
      --blur: 14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Segoe UI", Roboto, sans-serif;
      background:#0b141a;
      color:var(--text);
      height:100vh;
      display:grid;
      place-items:center;
    }
    .shell{width:95vw;max-width:1100px;height:90vh;display:grid;place-items:center}
    .card{background:var(--panel);border-radius:var(--radius);box-shadow:0 20px 60px #0008}
    /* AUTH */
    #auth{display:grid;grid-template-columns:1fr 1fr;gap:20px;padding:20px}
    .hero{background:linear-gradient(135deg,#06453f,#075E54,#128C7E);border-radius:var(--radius);padding:30px;color:#fff;display:flex;flex-direction:column;justify-content:space-between}
    .logo{font-weight:800;font-size:22px}
    .auth-panel{display:grid;gap:12px;padding:24px}
    .tabs{display:flex;background:#0b1222aa;border-radius:12px;padding:6px;border:1px solid #1e2e33}
    .tab{flex:1;text-align:center;padding:10px;border-radius:10px;cursor:pointer;color:var(--muted)}
    .tab.active{background:#0e1b1e;color:var(--text)}
    .field{display:grid;gap:6px}
    .input{padding:12px;border-radius:12px;border:1px solid #173035;background:#0f1a1d;color:var(--text)}
    .btn{padding:12px;border-radius:12px;border:none;cursor:pointer;background:#128C7E;color:#fff;font-weight:700}
    .btn.secondary{background:#0b1214;border:1px solid #1e2e33;color:#d5def0}
    .hidden{display:none!important}
    /* APP */
    .app{display:grid;grid-template-columns:320px 1fr;gap:10px;height:100%}
    .sidebar{display:grid;grid-template-rows:auto 52px 1fr auto;overflow:hidden;border-radius:var(--radius)}
    .wa-topbar{background:#075E54;padding:14px;display:flex;align-items:center;justify-content:space-between;color:#fff}
    .search{padding:10px;background:#0b1214;border-bottom:1px solid #0f2327}
    .search input{width:100%;padding:10px;border-radius:20px;border:none;background:#0f1a1d;color:var(--text)}
    .threads{overflow:auto;background:#0b1214}
    .thread{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid #0f2327;cursor:pointer}
    .thread:hover{background:#0f171a}
    .avatar{width:40px;height:40px;border-radius:50%;background:#173035;display:grid;place-items:center;font-weight:700}
    .meta .title{font-weight:700}
    .meta .last{font-size:12px;color:#9fb0c9}
    .room{display:grid;grid-template-rows:auto 1fr auto;border-radius:var(--radius);border:1px solid #0f2327;background:#0b1214}
    .room-head{background:#075E54;padding:14px;display:flex;justify-content:space-between;align-items:center;color:#fff}
    .chat{padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"220\" height=\"220\" opacity=\"0.04\"><circle cx=\"20\" cy=\"20\" r=\"2\" fill=\"white\"/></svg>') repeat}
    .msg{max-width:74%;padding:10px;border-radius:12px;background:#111b1e;color:#fff}
    .msg.me{margin-left:auto;background:var(--wa-chat);color:#000}
    .msg .time{font-size:11px;margin-top:4px;text-align:right;color:#9fb0c9}
    .msg.me .time{color:#2c5a51}
    .ticks{font-size:12px;margin-left:4px;opacity:.8}
    .ticks.read{color:#4ea3ff}
    .composer{display:flex;gap:10px;padding:10px;background:#0f171a;border-top:1px solid #0f2327}
    .composer input{flex:1;padding:12px;border-radius:22px;border:none;background:#0f1a1d;color:var(--text)}
    .composer button{background:#128C7E;border:none;border-radius:22px;padding:12px 18px;color:#fff;cursor:pointer}
    .toast{position:fixed;bottom:16px;right:16px;background:#101a33;padding:10px 14px;border-radius:8px;display:none}
  </style>
</head>
<body>
<div class="shell">
  <section id="auth" class="card">
    <div class="hero">
      <div class="logo">LuxChat</div>
      <div>
        <p>Private WhatsApp-style chat with end-to-end encryption. Register or login to start.</p>
      </div>
    </div>
    <div class="auth-panel">
      <div class="tabs">
        <div class="tab active" data-tab="login">Login</div>
        <div class="tab" data-tab="register">Register</div>
      </div>
      <form id="loginForm">
        <div class="field"><label>Username</label><input class="input" id="loginUser" required></div>
        <div class="field"><label>Password</label><input class="input" id="loginPass" type="password" required></div>
        <button class="btn" type="submit">Login</button>
      </form>
      <form id="registerForm" class="hidden">
        <div class="field"><label>Username</label><input class="input" id="regUser" required></div>
        <div class="field"><label>Password</label><input class="input" id="regPass" type="password" required></div>
        <button class="btn" type="submit">Register</button>
      </form>
    </div>
  </section>

  <section id="app" class="app hidden">
    <aside class="sidebar card">
      <div class="wa-topbar">
        <div>LuxChat</div><div>â‹®</div>
      </div>
      <div class="search"><input id="search" placeholder="Search or start new chat..."></div>
      <div class="threads" id="threads"></div>
      <div style="padding:10px">
        <input id="newRoom" class="input" placeholder="Room name" />
        <button id="addRoom" class="btn secondary">New</button>
      </div>
      <button id="logoutBtn" class="btn secondary" style="margin:10px">Logout</button>
    </aside>

    <main id="roomPanel" class="room card">
      <div class="room-head"><div id="roomTitle">No chat selected</div><div id="statusBadge">Offline</div></div>
      <div id="chat" class="chat"><div class="msg">Welcome to LuxChat!</div></div>
      <div class="composer">
        <input id="message" placeholder="Type a message" maxlength="400"/>
        <button id="send">âž¤</button>
      </div>
    </main>
  </section>
  <div class="toast" id="toast"></div>
</div>

<!-- Firebase & App Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAaxuleENvEkCeyGT-fpbD2MucqYqrTVKs",
    authDomain: "chating-37001.firebaseapp.com",
    databaseURL: "https://chating-37001-default-rtdb.firebaseio.com",
    projectId: "chating-37001",
    storageBucket: "chating-37001.firebasestorage.app",
    messagingSenderId: "34963823190",
    appId: "1:34963823190:web:1a799357de4b552564b9f7",
    measurementId: "G-FY3X1671VP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const qs = (s)=>document.querySelector(s);
  const toast=(t)=>{const el=qs('#toast');el.textContent=t;el.style.display='block';setTimeout(()=>el.style.display='none',2000)}

  const state={user:null,currentRoom:null};
  const bc=('BroadcastChannel' in self)?new BroadcastChannel('luxchat'):null;

  // Tabs
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      qs('#loginForm').classList.toggle('hidden',tab.dataset.tab!=='login');
      qs('#registerForm').classList.toggle('hidden',tab.dataset.tab!=='register');
    };
  });

  // Firebase Register
  async function registerFirebase(username,password){
    try{
      const email=`${username}@luxchat.local`;
      const userCred=await createUserWithEmailAndPassword(auth,email,password);
      await set(ref(db,'users/'+userCred.user.uid),{username,createdAt:Date.now()});
      toast('Registered successfully');
      return true;
    }catch(e){toast(e.message);return false;}
  }

  // Firebase Login
  async function loginFirebase(username,password){
    try{
      const email=`${username}@luxchat.local`;
      await signInWithEmailAndPassword(auth,email,password);
      localStorage.setItem('luxchat_user',username);
      enterApp(username);
      toast('Login success');
      return true;
    }catch(e){toast(e.message);return false;}
  }

  qs('#registerForm').onsubmit=async e=>{
    e.preventDefault();
    const u=qs('#regUser').value.trim();
    const p=qs('#regPass').value;
    if(await registerFirebase(u,p)) qs('[data-tab=\"login\"]').click();
  };

  qs('#loginForm').onsubmit=async e=>{
    e.preventDefault();
    const u=qs('#loginUser').value.trim();
    const p=qs('#loginPass').value;
    await loginFirebase(u,p);
  };

  function enterApp(u){
    state.user=u;
    qs('#auth').classList.add('hidden');
    qs('#app').classList.remove('hidden');
    renderRooms();
    Notification.requestPermission();
  }

  function renderRooms(){
    const wrap=qs('#threads');wrap.innerHTML='';
    const rooms=JSON.parse(localStorage.getItem('lux_rooms_'+state.user)||'[]');
    if(rooms.length===0){wrap.innerHTML='<div style=\"padding:10px;color:#aaa\">No chats yet</div>';}
    rooms.forEach(r=>{
      const el=document.createElement('div');
      el.className='thread';
      el.innerHTML=`<div class='avatar'>ðŸ’¬</div><div class='meta'><div class='title'>${r}</div></div>`;
      el.onclick=()=>openRoom(r);
      wrap.appendChild(el);
    });
  }

  qs('#addRoom').onclick=()=>{
    const r=qs('#newRoom').value.trim();
    if(!r)return;
    let rooms=JSON.parse(localStorage.getItem('lux_rooms_'+state.user)||'[]');
    if(!rooms.includes(r))rooms.push(r);
    localStorage.setItem('lux_rooms_'+state.user,JSON.stringify(rooms));
    qs('#newRoom').value='';
    renderRooms();openRoom(r);
  };

  function openRoom(r){
    state.currentRoom=r;
    qs('#roomTitle').textContent=r;
    renderChat();
  }

  function renderChat(){
    const box=qs('#chat');box.innerHTML='';
    const msgs=JSON.parse(localStorage.getItem('lux_msgs_'+state.user+'_'+state.currentRoom)||'[]');
    msgs.forEach(m=>{
      const div=document.createElement('div');div.className='msg'+(m.me?' me':'');
      div.innerHTML=`${m.text}<div class='time'>${new Date(m.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}${m.me?'<span class=\"ticks '+(m.read?'read':'')+'\">âœ“âœ“</span>':''}</div>`;
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  }

  qs('#send').onclick=sendMessage;
  qs('#message').onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();sendMessage();}}

  function sendMessage(){
    const text=qs('#message').value.trim();
    if(!text||!state.currentRoom)return;
    const msg={text,ts:Date.now(),me:true};
    const key='lux_msgs_'+state.user+'_'+state.currentRoom;
    const msgs=JSON.parse(localStorage.getItem(key)||'[]');
    msgs.push(msg);localStorage.setItem(key,JSON.stringify(msgs));
    renderChat();
    qs('#message').value='';
    if(bc)bc.postMessage({room:state.currentRoom,text,from:state.user});
  }

  if(bc)bc.onmessage=e=>{
    const d=e.data;if(!d||d.from===state.user)return;
    const key='lux_msgs_'+state.user+'_'+d.room;
    const msgs=JSON.parse(localStorage.getItem(key)||'[]');
    msgs.push({text:d.text,ts:Date.now(),me:false});
    localStorage.setItem(key,JSON.stringify(msgs));
    if(state.currentRoom===d.room)renderChat();
    if(Notification.permission==='granted')new Notification('New message from '+d.from,{body:d.text});
  };

  // Logout
  qs('#logoutBtn').onclick=()=>{
    localStorage.removeItem('luxchat_user');
    location.reload();
  };

  // Auto-login if session
  const sess=localStorage.getItem('luxchat_user');
  if(sess)enterApp(sess);
</script>
</body>
</html>
